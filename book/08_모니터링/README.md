# CHAPTER 8. 모니터링

시스템을 더 세분화된 마이크로서비스로 분해하면 많은 혜택을 얻지만 실환경 시스템을 모니터링하는 관점에서 볼 때 복잡성도 증가한다. 이 장에서는 세분화된 시스템에서 발생하는 문제의 인식과 모니터링에 연관된 도전을 살펴보고 이 둘을 모두 취하기 위해 할 수 있는 것에 대해서 설명한다.

일단, 작은 것들을 모니터링하고 전체 상황을 볼 수 있도록 취합하는 것이 좋다.



## 8.1 단일 서비스, 단일 서버

먼저 호스트 자체를 모니터링 해야한다. CPU와 메모리는 매우 유용한 정보다. 시스템이 정상일 때 이들의 정상 범위를 알고 있어야 범위를 벗어날 때 주의 경보(alert)를 보낼 수 있다.

그 다음으로 서버 자체의 로그에 접근하고 싶어 한다. 만약 사용자가 에러 리포트를 한다면 로그는 에러를 추출해야 하고 언제 어디서 그것이 발생했는지도 알려주어야 한다.

끝으로 애플리케이션 자체를 모니터링하고 싶어 한다. 최소한 서비스의 응답시간을 모니터링하는 것이 좋다. 아마도 서비스 앞단에 위치한 웹 서버의 로그나 서비스 자체의 로그를 관찰하면서 응답시간을 모니터링할 수 있을 것이다.



## 8.2 단일 서비스, 다수 서버

실행되는 서비스의 복제본들이 분리된 호스트 상에 있다면 요청은 부하 분산기(Load Balancer)를 통해 다른 서비스 인스턴스로 전달된다. 여전히 이전처럼 동일한 모든 것을 모니터링하고 싶어한다. 이때 문제가 발생했을 때 개별 호스트뿐만 아니라 모든 호스트에 발새오딘 것인지도 알기 원한다. 다시 말해, 모든 것을 취합하고 세부 분석을 할 수 있어야 한다.

다수의 서버에서 발생하는 서비스 로그 또한 각 서버에 로그인해 검색하는 것은 귀찮은 일이다. 단지 몇 개의 호스트만 있다면 여러 호스트에 동일한 명령 실행이 가능한 멀티플랙서와 같은 도구를 사용하는 것도 방법이다.



## 8.3 다수 서비스, 다수 서버

다수의 물리적 또는 가상 호스트에서 실행되는 다수의 서비스는 사용자에게 기능을 제공하기 위해 협업하고 있다. 많은 호스트에서 생성되는 수천 줄의 로그에서 우리가 찾으려는 에러를 어떻게 발견할 수 있을까? 한 서버가 오작동하는 것인지 또는 시스템 전체적인 문제인지 어떻게 판별할 수 있을까?

해결책은 로그부터 애플리케이션 측정지표까지 가능한 한 많은 수집과 집중식 취합을 하는 것이다.



## 8.4 로그, 로그, 더 많은 로그...

더 이상 로그를 추출하기 위한 SSH 멀티플랙싱으로는 어림도 없으며 모든 호스트의 터미널을 보여주기에 충분히 큰 스크린도 없다. 대신 로그를 수집하고 중앙에서 접근하기 위해 전문적인 서브시스템을 사용하려 한다. 이에 대한 한 가지 예는 많은 로그 파일 포맷을 파싱하고 추가 분석을 위해 하부 시스템에 전송할 수 있는 로그스태쉬(logstash)다. -> ELK 스택



## 8.5 다수 서비스 간의 측정지표 추적

복잡한 시스템에서 측정지표를 살펴볼 때는 어느 것이 정상 사앹인지 알기 어렵다. 그렇기 때문에 문제가 발생할 때,  명확한 패턴이 드러나도록 오랜 기간에 걸쳐 시스템의 행동 방식에 대한 측정지표를 수집해야 한다.

복잡한 환경에서는 서비스들의 인스턴스가 매우 빈번히 프로비저닝되기 때문에 우리가 선택한 시스템이 새로운 호스트로부터 측정지표를 매우 쉽게 수집하기를 원한다. 그래파이트(Graphite)는 이를 매우 쉽게 만들어주는 시스템 중 하나다. 그래파이트는 여러 표본을 취합하고 한 표본을 따라 자세히 검색함으로써 전체 시스템, 서비스 그룹, 또는 단일 인스턴스에 대한 응답시간을 알 수 있다.



## 8.6 서비스 측정지표

서비스 스스로 기본적인 측정지표를 발산해야 한다. 웹 서비스라면 최소한 기본으로 응답시간과 에러율 같은 측정지표를 노출해야 한다. 더 나아가서 커스텀한 지표들까지도 기록하기를 원할 수 있다.

이러한 지표들이 필요한 이유는 많다.

1. 해당 기능이 정말 사용되고 있는 것인지 인지하기 위함. (실제 소프트웨어 기능의 80%는 사용되지 않는다는 속설이 있다.)
2. 시스템을 어떻게 개선해야 할지 알기 위해 사용자가 우리 시스템을 사용하는 방식을 알아야한다.
3. 어떤 데이터가 유용한지 알 수 없기 때문. 어떤 것에 도움을 주는 데이터를 수집할 기회가 한참 지난 후에야 그 데이터가 필요한 경우가 있다.



## 8.7 합성 모니터링

>웹 애플리케이션을 모니터링하는 방법에 따라 합성 모니터링과 실사용자 모니터링으로 나눌 수 있다. 합성 모니터링은 통제된 모니터링, 능동 모니터링 또는 유의적 모니터링으로 불리며 운영 중인 시스템에 자동화된 테스트의 하위 집합을 실행해 모니터링하는 기술이다.



### 8.7.1 유의적 모니터링 구현하기

과거에는 유의적 모니터링을 구현하는 것은 꽤 도전하기 벅찬 일이었지만 지금은 많이 쉬워졌다.

특정 서비스나 시스템 전체의 엔드 투 엔드 테스트를 살펴보면 유의적 모니터링 구현에 필요한 많은 것을 이미 보유하고 있다는 것을 알 수 있다. 즉 시스템은 테스트 실행과 결과 확인에 필요한 수단을 이미 제공하고 있다. 그러므로 이 테스트의 일부 집합을 시스템을 지속적으로 모니터링하는 방법으로 사용하는 것은 어떨까?



## 8.8 상관관계 ID

최종 사용자에게 어떠한 기능이라도 제공하기 위해서는 수 많은 서비스 상호작용이 필요하므로 하나의 초기 호출로 시작하여 다수의 하위 서비스에 대한 호출로 분화할 수 있다. 이렇게 여러 하위 서비스들로 이루어진 환경에서 문제가 발생하고 그 문제를 재현하기 위해서는 어떻게 호출 흐름을 재구성할 수 있을까?

이때, 상관관계 ID를 이용할 수 있다. 첫 호출이 이뤄질 때 호출에 대한 전역 호출 식별자(GUID)를 생성하고 후속하는 모든 호출에 전달한다. 그리고 로그와 함께 출력하는 것이다.



## 8.9 전파

전파 쟁애는 특히 위협적이다. 그러므로 시스템 간의 통합 지점을 모니터링하는 것이 중요하다. 각 서비스 인스턴스는 데이터베이스부터 협업하는 다른 서비스에 이르기까지 하위 의존성 상태를 추적하고 노출해야 한다. 또한 이러한 정리된 현황을 알 수 있도록 수집된 정보들을 취합해야 한다.



## 8.10 표준화

지속적으로 균형을 유지해야 할 행동 중 하나는 단일 서비스만을 위한 제한된 결정과 시스템 전체를 표준화할 결정을 언제 내려야 하는지 판단하는 것이다. 모니터링은 표준화가 엄청나게 중요한 분야다. (ex. 로그는 표준 포맷으로 출력해야 한다.)



## 8.11 관객 고려하기

수집하는 모든 데이터에는 목적이 있다. 그리고 데이터를 살펴보려는 사람들의 유형에 따라 다음 사항을 고려하라.

- 어떤 것을 당장 알아야 하는가?
- 어떤 것을 나중에 알아도 되는가?
- 어떻게 데이터를 소비하고 싶은가?



## 8.13 마치며

각 서비스에 대해

- 최소한의 필수 사항으로 응답시간을 추적하고 그다음에 에러율을 추적하라. 그리고 나서 애플리케이션 레벨 측정지표에 대해 작업하라.
- 모든 하위 응답 상태를 추적하라. 최소한 하위 호출의 응답시간을 포함하고, 할 수 있다면 에러율도 추적하라.
- 측정 지표가 수집될 방식과 저장소를 표준화하라.
- 가능하면 표준 저장소와 표준 포맷으로 로깅하라. 모든 서비스가 다른 형식을 사용한다면 취합은 매우 어렵다.
- 불량 프로세스를 추적하고 용량 계획을 수행할 수 있도록 하부 운영 체제를 모니터링하라.

시스템에 대해

- 애플리케이션 레벨 측정지표와 함께 CPU처럼 호스트 레벨 측정지표도 취합하라.
- 측정지표 저장소 도구가 시스템 또는 서비스 레벨로 집계할 수 있는지 확인하고 개별 호스트 레벨까지 탐색해서 보여줘라.
- 측정지표 저장소 도구가 시스템의 추이를 이해할 정도로 오랜 기간 데이터를 유지할 수 있는지 확인하라.
- 로그를 취합하고 저장하는 데 질의 가능한 단 하나의 도구를 사용하라.
- 상관관계 ID를 사용하는 데 있어 표준화를 반드시 고려하라.